<?xml version="1.0" encoding="UTF-8"?>

<metamorph xmlns="http://www.culturegraph.org/metamorph" version="1">

	<macros>
		<macro name="make080CategoriesAllSubX" >
			<concat name="$[out]"
					 delimiter=""
					    flushWith="080*a" sameEntity="false" reset="false">

				<data source="080*.x" />

			</concat>
		</macro>

		<macro name="make080CategoriesAllSubX1" >

				<data source="080*.x"  name="$[out]"/>



		</macro>



	</macros>


	<rules>

		<data source="001" name="@id" />

		<data name="id" source="@id"  />

		<data source="_id" name="recordtype">
			<constant value="marc"/>
		</data>

		<entity name="language[]" flushWith="record">
			<data source="0410 .a|041  .a" >
				<blacklist>
					<entry name="und"/>
					<entry name="||"/>
				</blacklist>
				<regexp match="(^...$|^..$|^.$)"  />
			</data>

			<data source="008" >
				<substring start="35" end="38"/>
				<blacklist>
					<entry name="und"/>
					<entry name="||"/>
				</blacklist>

			</data>

		</entity>
		<entity name="origcountry_isn_mv[]" flushWith="record" >
			<data source="008" >
				<substring start="15" end="18"/>
			</data>
			<data source="044*.a" />
		</entity>

		<!-- Classifications -->

		<entity name="classif_912[]" flushWith="record">
			<data source="912*.a" />
		</entity>



		<call-macro name="make080CategoriesAllSubX1"   out="@valuesubX" />

		<entity flushWith="080*.a"  name="myConcat[]" reset="true">
			<data name="" source="080*.a|080*.x|080*.b" />

		</entity>


		<entity name="080Feld[]" flushWith="record">

			<if>
				<data source="080*.a"/>
			</if>


			<combine name="" value="${o1}${o2}" reset="false">
				<data source="080*.a" name="o1"/>
				<data source="@valuesubX" name="o2" />
			</combine>

			<!--
			<square name="" delimiter="">
				<data source="080*.a" name="o1"/>
				<data source="@valuesubX" name="o2" />
			</square>
			-->

		</entity>


		<entity name="mitInnerCombine[]" flushWith="record">
			<combine name=""
					 value="${a}${x}"
					 flushWith="080*.x" reset="true">

				<combine name="a" value="${value}" reset='false'>
					<data source="080*.a" name="value"/>
					<!--<data source="080*.x" />-->
				</combine>

				<combine name="x" value="${allX}">
					<data source="080*.x" name="allX" >
						<buffer flushWith="080*.a"/>
					</data>
				</combine>

			</combine>
		</entity>
		<entity name="onlyX[]" >
				<combine name="aa" value="${a}${x}">
					<data source="080*.a" name="a"/>
					<data source="080*.x" name="x">
						<buffer flushWith="080*.a" />
					</data>
				</combine>
			<!--</combine> -->

		</entity>


		<entity name="testWithGroup[]" flushWith="record" sameEntity="false">

			<data source="080*.a" name="080a"/>
			<group>
				<concat name="" delimiter="" >
					<data source="080*.x"  />
				</concat>
			</group>

		</entity>

		<entity name="testWithGroupCombine[]"  sameEntity="false">

			<combine name="" value="${o1}${o2}">
				<data source="080*.a"  name="o1"/>
				<group name="o2" >
				<concat name="" delimiter="" reset="true">
					<data source="080*.x"  />
				</concat>
				</group>
			</combine>

		</entity>
		<!--<data source="_else"/>-->

	</rules>

</metamorph>
